# Посібник для агентів cplot

## Призначення документа
- Служить контрольним списком для агентів, що змінюють репозиторій.
- Узагальнює вимоги до коду, документації, тестів і робочого процесу.
- Допомагає підтримувати узгодженість української локалізації та безпечну роботу з обладнанням.

## Огляд проєкту
- CLI-застосунок на C для перетворення тексту у контурні шляхи Hershey, формування превʼю SVG/PNG та керування AxiDraw через EBB.
- Збірка портативна: без зовнішніх залежностей, достатньо `clang` або `gcc` на macOS/Linux.
- Вся видима інформація (журнали, довідка, README, коментарі) має бути українською.

## Структура репозиторію
- `src/` — основні модулі (див. нижче «Архітектура»).
- `hershey/` — шрифти Hershey, що розповсюджуються з дистрибутивом.
- `docs/` — довідкові матеріали (motion planning, GRBL, EBB).
- `bin/` — зібрані бінарники (`make` створює `bin/cplot`).
- `lib/` — артефакти проміжної збірки (`*.o`, `*.d`).
- `packaging/`, `project.conf`, `Makefile` — конфігурація збірки та релізів.

## Збірка та форматування
- Debug-збірка: `make` (типово `BUILD=debug`).
- Release-збірка: `make BUILD=release`; для CPU-специфічної оптимізації встановіть `PORTABLE=0`.
- Форматування: `make fmt` (потрібен `clang-format` у PATH).
- Дистрибутив: `make dist` → `dist/*.tar.gz` + SHA256.

## Аргументи CLI і хелп
- `src/args.c` — єдине джерело правди для опцій/команд.
- Додаткові опції додавайте одночасно до `k_long_options[]`, `k_option_descs[]` і відповідних хендлерів.
- `src/help.c` автоматично генерує довідку з `args.c`; текст короткий, без дублювання.

## Архітектура основних модулів
- `src/main.c` — ініціалізація локалі, логування, запуск CLI.
- `src/cli.c` — маршрутизація підкоманд: `print`, `device`, `config`, `fonts`, `version`.
- `src/cmd.c` — фасади для виконання команд, взаємодія з AxiDraw та превʼю.
- `src/drawing.c` — побудова розкладки, SVG/PNG превʼю.
- `src/axidraw.c`, `src/ebb.c`, `src/serial.c` — протокол EBB, блокування доступу, взаємодія з пристроєм.
- `src/config.c` — JSON-конфіг без сторонніх бібліотек, XDG-шлях.
- `src/log.c` — журнали (`CPLOT_LOG`, `CPLOT_LOG_NO_COLOR`, `--verbose`, `--no-colors`).
- `src/planner.c`, `src/stepper.c` — планування рухів, профілі швидкостей.
- `src/text.c`, `src/font*.c`, `src/glyph.c` — рендеринг тексту Hershey.

## Конфігурація
- Типові ключі (`config --set`): поля (`margin`, `margin_*`), `font_size`, `font_family`, `speed`, `accel`, `pen_*_speed`, `pen_*_delay`, `servo_timeout`, `device-name`/`default_device`.
- Одноразові параметри (орієнтація, розміри паперу, дії з пером/моторами) **не** зберігаємо у конфіг.
- Додаючи ключ, оновіть: `k_cfg_keys[]` у `src/args.c`, `config_apply_pair()` у `src/cmd.c`, перевірки у `config_validate()` (за потреби).

## Робота з пристроєм AxiDraw
- Використовуйте `with_axidraw_device()` (шаблон із `cmd.c`) для підключення/відʼєднання.
- Блокування доступу — через lock-файл у `TMPDIR` (`axidraw_device_lock_*`). Не змінюйте семантику без вагомих причин.
- Команди, що торкаються «заліза», тестуйте у режимі `--dry-run` або через превʼю.
- Поважайте тайм-аути, FIFO, rate limit (`axidraw_set_rate_limit`, `axidraw_set_fifo_limit`).

## Журналювання та локалізація
- Логування й повідомлення лише українською; без англомовних вставок.
- `--verbose` підвищує рівень логів до DEBUG; `--no-colors` вимикає ANSI-кольори незалежно від ENV.
- У stdout друкуйте лише результати команд (SVG/PNG/списки), не журнали.

## Стиль коду
- Стандарт: GNU C99 (`-std=gnu99`), високий рівень warning’ів (`-Wall -Wextra -pedantic`).
- Код має бути лаконічним, з короткими функціями й мінімальними, змістовними коментарями.
- Не додавайте зовнішніх залежностей.
- Переважайте ASCII, але українські тексти припустимі для локалізації.

## Тестування та smoke-перевірки
- Мінімальний набір: `bin/cplot --help`, `echo "Hello" | bin/cplot print --preview`, `echo "Hello" | bin/cplot print --preview --png`, `bin/cplot device list` (без підключеного пристрою).
- Не виконуйте апаратні дії (home, motors on/off, pen up/down) без реального пристрою або прямої вказівки користувача.
- `make` має проходити без помилок перед здачею змін.

## Реліз і пакування
- `make release` — збірка у релізному режимі, `strip` для бінарника.
- `make dist` — пакування з `LICENSE`, `README.md`, шрифтами та бінарником у `dist/` + `.sha256`.

## Робочий процес агента
- Перед серією shell-команд стисло пояснюйте намір; використовуйте `shell` з `workdir` без `cd`, якщо можливо.
- Для багатокрокових задач виконуйте планування через `update_plan`; не створюйте одноетапні плани.
- Редагування здійснюйте через `apply_patch`; змінюйте лише необхідні ділянки.
- Не торкайтеся чужих (існуючих) незавершених правок, якщо користувач не просив.
- Якщо помічаєте несподівані зміни, зупиніться та уточніть у користувача.
- Не комітіть та не створюйте гілки без прямого запиту.

## Рецепти поширених змін
1. **Новий ключ конфігурації**
   - Додайте елемент у `k_cfg_keys[]` (`src/args.c`).
   - Реалізуйте розбір у `config_apply_pair()` (`src/cmd.c`), врахуйте валідацію.
   - За потреби оновіть `config_validate()` та smoke-перевірку `config --show` / `config --set`.
2. **Нова опція CLI для `print`/`device`/`shape`**
   - Додайте записи до `k_long_options[]` і `k_option_descs[]` (`src/args.c`).
   - Розпишіть розбір у відповідному хендлері (`handle_layout_option`, `handle_device_option`, `handle_shape_option`).
   - Оновіть довідку в `src/help.c` (списки дій, групи опцій) та перевірте `bin/cplot --help`.
3. **Нова дія пристрою**
   - Розширте парсер (`parse_device_tokens()`), описи в `help.c` і реалізацію `cmd_device_*`.
   - Використовуйте `with_axidraw_device()` для безпечної взаємодії; дотринкуйтесь лімітів FIFO/rate.

## Корисні матеріали
- `docs/ebb.md` — нотатки протоколу EBB.
- `docs/motion.md` — планування руху та контекст GRBL.
- `docs/grbl.md` — деталі сумісності.

## Додаткові зауваги
- README, help і журнали вже локалізовані; підтримуйте стиль і термінологію.
- Перед здачею перевіряйте, чи не додали англомовних фрагментів у користувацький вивід.
- Будь-які відхилення від цих правил узгоджуйте з користувачем та документуйте.
